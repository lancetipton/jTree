((typeof self !== 'undefined' ? self : this)["webpackJsonp_name_"] = (typeof self !== 'undefined' ? self : this)["webpackJsonp_name_"] || []).push([["render-js-store-store"],{

/***/ "./src/scripts/modules/renders/js/store/actions.js":
/*!*********************************************************!*\
  !*** ./src/scripts/modules/renders/js/store/actions.js ***!
  \*********************************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
var actions = ['ADD_DATA', 'UPDATE_ITEM', 'UPDATE_SELECTED', 'UPDATE_EXPANDED', 'UPDATE_EDIT'].reduce(function (actions, action) {
  return (actions[action.toUpperCase()] = action.toUpperCase()) && actions;
}, {});
/* harmony default export */ __webpack_exports__["default"] = (actions);

/***/ }),

/***/ "./src/scripts/modules/renders/js/store/dispatcher.js":
/*!************************************************************!*\
  !*** ./src/scripts/modules/renders/js/store/dispatcher.js ***!
  \************************************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var lodash_clonedeep__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! lodash.clonedeep */ "./node_modules/lodash.clonedeep/index.js");
/* harmony import */ var lodash_clonedeep__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(lodash_clonedeep__WEBPACK_IMPORTED_MODULE_0__);
function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }


var WATCHERS = {};
var ON_DISPATCH;
var STATE;

var isFunc = function isFunc(test) {
  return typeof test === 'function';
};

var destroy = function destroy() {
  return Object.entries(WATCHERS).map(function (_ref) {
    var _ref2 = _slicedToArray(_ref, 2),
        id = _ref2[0],
        cbs = _ref2[1];

    cbs && cbs.map(function (cb) {
      return cb && typeof cb.destroy === 'function' && cb.destroy(id);
    });
    WATCHERS[watcher] = undefined;
    delete WATCHERS[watcher];
  });
};

var dispatch = function dispatch(id) {
  if (!ON_DISPATCH) return console.warn("You must create a store before you can dispatch to it");

  for (var _len = arguments.length, payload = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    payload[_key - 1] = arguments[_key];
  }

  return update(ON_DISPATCH.apply(void 0, [STATE, id].concat(payload)), id);
};

var create = function create(onDispatch, state) {
  if (ON_DISPATCH || STATE) return console.warn("dispatcher.create should only be call once for an application");
  if (!onDispatch || !isFunc(onDispatch)) return console.warn("dispatcher.create requires an 'onDispatch' method");
  if (!state || (typeof store === "undefined" ? "undefined" : _typeof(store)) !== 'object') return console.warn("create requires an initial state of type 'object'");
  ON_DISPATCH = onDispatch;
  STATE = lodash_clonedeep__WEBPACK_IMPORTED_MODULE_0___default()(state);
  return STATE;
};
/**
 * Checks the state for an update, and updates when needed
 * Calls all cbs linked to the passed in id
 * @param  {any} updatedState - new changes
 * @param  {any} id - used to find the linked callbacks
 * @param  {any} key - used to find the location of the state that was updated
 * @return { void }
 */


var update = function update(updatedState, id) {
  // If no updated state, or the current state is equal to the update state
  // No update, so just return
  if (!updatedState || STATE === updatedState) return STATE; // Otherwise update the state with the updateState param

  STATE = _objectSpread({}, STATE, updatedState);
  var cbs = WATCHERS[id];
  cbs && cbs.length && cbs.map(function (cb) {
    return typeof cb === 'function' && cb(STATE);
  });
  return STATE;
};

var watch = function watch(id, cb) {
  if (!cb || typeof cb !== "function") console.warn("You must pass a function as the second argument to store.listen()");
  WATCHERS[id] = WATCHERS[id] || [];
  WATCHERS[id].push(cb);
};

var getWatchers = function getWatchers() {
  return WATCHERS;
};

var forget = function forget(id, cb) {
  if (!id || !WATCHERS[id]) console.warn("You must pass and id to forget a watcher");
  var cbIndex = WATCHERS[id].indexOf(cb);
  cbIndex !== -1 && WATCHERS[id].splice(cbIndex, 1);
};

var dispatcher = {
  create: create,
  destroy: destroy,
  dispatch: dispatch,
  forget: forget,
  getWatchers: getWatchers,
  watch: watch,
  update: update
};
/* harmony default export */ __webpack_exports__["default"] = (dispatcher);

/***/ }),

/***/ "./src/scripts/modules/renders/js/store/store.js":
/*!*******************************************************!*\
  !*** ./src/scripts/modules/renders/js/store/store.js ***!
  \*******************************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _dispatcher__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./dispatcher */ "./src/scripts/modules/renders/js/store/dispatcher.js");
/* harmony import */ var _actions__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./actions */ "./src/scripts/modules/renders/js/store/actions.js");
function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }



var dispatch = _dispatcher__WEBPACK_IMPORTED_MODULE_0__["default"].dispatch,
    watch = _dispatcher__WEBPACK_IMPORTED_MODULE_0__["default"].watch,
    forget = _dispatcher__WEBPACK_IMPORTED_MODULE_0__["default"].forget,
    create = _dispatcher__WEBPACK_IMPORTED_MODULE_0__["default"].create; // this is used to define if an item should be re-rendered
// it should contain anything that can be changed by a user

var serialItem = function serialItem(item) {
  return [!!item.visible, !!item.expanded, !!item.selected, !!item.edit].join("");
};

var initialState = {
  data: [],
  selected: null,
  childrenCache: {},
  itemCache: {},
  isModalVisible: false
};

var getItem = function getItem(idOrItem, state) {
  return typeof idOrItem === "string" ? state.itemCache[idOrItem] : idOrItem;
};

var getParent = function getParent(item, state) {
  if (item.parentItem) return item.parentItem;
  if (!item.parentId) return null;
  item.parentItem = getItem(item.parentId, state);
  return item.parentItem;
};

var getChildrenOf = function getChildrenOf(id, state) {
  if (id in state.childrenCache) return state.childrenCache[id];
  children = state.data.filter(function (item) {
    return item.parentId === id;
  });
  return children && children.length ? children : false;
};

var updateItemCache = function updateItemCache(itemCache, item) {
  return _objectSpread({}, itemCache, _defineProperty({}, item.id, _objectSpread({}, itemCache[item.id], item)));
};

var onDispatch = function onDispatch(state) {
  for (var _len = arguments.length, action = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    action[_key - 1] = arguments[_key];
  }

  var type = action.type,
      payload = _objectWithoutProperties(action, ["type"]);

  if (!type || !Object.keys(payload).length) return state;

  switch (type) {
    case _actions__WEBPACK_IMPORTED_MODULE_2__["default"].ADD_DATA:
      {
        // newData === Array
        return !payload.newData ? state : _objectSpread({}, state, {
          data: updated.data.concat(payload.newData),
          itemCache: payload.newData.reduce(function (itemCache, item) {
            return (itemCache[item.id] = item) && itemCache;
          }, updated.itemCache)
        });
      }

    case _actions__WEBPACK_IMPORTED_MODULE_2__["default"].UPDATE_ITEM:
      {
        if (!payload || !payload.id) return state;
        var item = getItem(payload.id, state); // If no update, or the item has not been update, just return

        return !item || serialItem(item) === serialItem(payload) ? state : _objectSpread({}, state, {
          itemCache: updateItemCache(state.itemCache, payload)
        });
      }

    case _actions__WEBPACK_IMPORTED_MODULE_2__["default"].UPDATE_SELECTED:
      {
        var _updated = _objectSpread({}, state, {
          selected: null // Remove current selected

        });

        if (state.selected) {
          var curId = state.selected.id;
          _updated.itemCache = updateItemCache(_updated.itemCache, _objectSpread({}, _updated.itemCache[curId], {
            selected: false
          }));
        } // Get the item to update


        var _item = getItem(payload.id, state); // if no item to update reutrn


        if (!_item) return _updated; // Update the passed in item to selected

        _updated.itemCache = updateItemCache(_updated.itemCache, _objectSpread({}, _item, {
          selected: true
        }));
        _updated.selected = _item; // return updated state

        return _updated;
      }

    case _actions__WEBPACK_IMPORTED_MODULE_2__["default"].UPDATE_EXPANDED:
      {
        var _children = getChildrenOf(payload.id, state);

        var _item2 = getItem(payload.id, state);

        return !_item2 ? state : _objectSpread({}, state, {
          itemCache: updateItemCache(updated.itemCache, _objectSpread({}, _item2, {
            expanded: payload.expanded
          })),
          childrenCache: _objectSpread({}, state.childrenCache, _defineProperty({}, _item2.id, _children && _children.map(function (child) {
            return (child.visible = payload.expanded) && child;
          }) || undefined))
        });
      }

    case _actions__WEBPACK_IMPORTED_MODULE_2__["default"].UPDATE_EDIT:
      {
        var _children2 = getChildrenOf(payload.id, state);

        var _item3 = getItem(payload.id, state);

        return !_item3 ? state : _objectSpread({}, state, {
          itemCache: updateItemCache(updated.itemCache, _objectSpread({}, _item3, {
            edit: payload.edit
          }))
        });
      }
  }
};

/* harmony default export */ __webpack_exports__["default"] = (function (startState) {
  return create(onDispatch, _objectSpread({}, initialState, startState));
});

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9bbmFtZV0vLi9zcmMvc2NyaXB0cy9tb2R1bGVzL3JlbmRlcnMvanMvc3RvcmUvYWN0aW9ucy5qcyIsIndlYnBhY2s6Ly9bbmFtZV0vLi9zcmMvc2NyaXB0cy9tb2R1bGVzL3JlbmRlcnMvanMvc3RvcmUvZGlzcGF0Y2hlci5qcyIsIndlYnBhY2s6Ly9bbmFtZV0vLi9zcmMvc2NyaXB0cy9tb2R1bGVzL3JlbmRlcnMvanMvc3RvcmUvc3RvcmUuanMiXSwibmFtZXMiOlsiYWN0aW9ucyIsInJlZHVjZSIsImFjdGlvbiIsInRvVXBwZXJDYXNlIiwiV0FUQ0hFUlMiLCJPTl9ESVNQQVRDSCIsIlNUQVRFIiwiaXNGdW5jIiwidGVzdCIsImRlc3Ryb3kiLCJPYmplY3QiLCJlbnRyaWVzIiwibWFwIiwiaWQiLCJjYnMiLCJjYiIsIndhdGNoZXIiLCJ1bmRlZmluZWQiLCJkaXNwYXRjaCIsImNvbnNvbGUiLCJ3YXJuIiwicGF5bG9hZCIsInVwZGF0ZSIsImNyZWF0ZSIsIm9uRGlzcGF0Y2giLCJzdGF0ZSIsInN0b3JlIiwiY2xvbmVEZWVwIiwidXBkYXRlZFN0YXRlIiwibGVuZ3RoIiwid2F0Y2giLCJwdXNoIiwiZ2V0V2F0Y2hlcnMiLCJmb3JnZXQiLCJjYkluZGV4IiwiaW5kZXhPZiIsInNwbGljZSIsImRpc3BhdGNoZXIiLCJzZXJpYWxJdGVtIiwiaXRlbSIsInZpc2libGUiLCJleHBhbmRlZCIsInNlbGVjdGVkIiwiZWRpdCIsImpvaW4iLCJpbml0aWFsU3RhdGUiLCJkYXRhIiwiY2hpbGRyZW5DYWNoZSIsIml0ZW1DYWNoZSIsImlzTW9kYWxWaXNpYmxlIiwiZ2V0SXRlbSIsImlkT3JJdGVtIiwiZ2V0UGFyZW50IiwicGFyZW50SXRlbSIsInBhcmVudElkIiwiZ2V0Q2hpbGRyZW5PZiIsImNoaWxkcmVuIiwiZmlsdGVyIiwidXBkYXRlSXRlbUNhY2hlIiwidHlwZSIsImtleXMiLCJBRERfREFUQSIsIm5ld0RhdGEiLCJ1cGRhdGVkIiwiY29uY2F0IiwiVVBEQVRFX0lURU0iLCJVUERBVEVfU0VMRUNURUQiLCJjdXJJZCIsIlVQREFURV9FWFBBTkRFRCIsImNoaWxkIiwiVVBEQVRFX0VESVQiLCJzdGFydFN0YXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7QUFBQSxJQUFNQSxPQUFPLEdBQUcsQ0FDZCxVQURjLEVBRWQsYUFGYyxFQUdkLGlCQUhjLEVBSWQsaUJBSmMsRUFLZCxhQUxjLEVBTWRDLE1BTmMsQ0FNUCxVQUFDRCxPQUFELEVBQVVFLE1BQVY7QUFBQSxTQUNQLENBQUNGLE9BQU8sQ0FBQ0UsTUFBTSxDQUFDQyxXQUFQLEVBQUQsQ0FBUCxHQUFnQ0QsTUFBTSxDQUFDQyxXQUFQLEVBQWpDLEtBQTBESCxPQURuRDtBQUFBLENBTk8sRUFRYixFQVJhLENBQWhCO0FBVWVBLHNFQUFmLEU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FDVkE7QUFFQSxJQUFNSSxRQUFRLEdBQUcsRUFBakI7QUFDQSxJQUFJQyxXQUFKO0FBQ0EsSUFBSUMsS0FBSjs7QUFDQSxJQUFNQyxNQUFNLEdBQUcsU0FBVEEsTUFBUyxDQUFBQyxJQUFJO0FBQUEsU0FBSSxPQUFPQSxJQUFQLEtBQWdCLFVBQXBCO0FBQUEsQ0FBbkI7O0FBQ0EsSUFBTUMsT0FBTyxHQUFHLFNBQVZBLE9BQVU7QUFBQSxTQUNkQyxNQUFNLENBQ0hDLE9BREgsQ0FDV1AsUUFEWCxFQUVHUSxHQUZILENBRU8sZ0JBQWdCO0FBQUE7QUFBQSxRQUFkQyxFQUFjO0FBQUEsUUFBVkMsR0FBVTs7QUFDbkJBLE9BQUcsSUFBSUEsR0FBRyxDQUFDRixHQUFKLENBQVEsVUFBQUcsRUFBRTtBQUFBLGFBQUlBLEVBQUUsSUFBSSxPQUFPQSxFQUFFLENBQUNOLE9BQVYsS0FBc0IsVUFBNUIsSUFBMENNLEVBQUUsQ0FBQ04sT0FBSCxDQUFXSSxFQUFYLENBQTlDO0FBQUEsS0FBVixDQUFQO0FBQ0FULFlBQVEsQ0FBQ1ksT0FBRCxDQUFSLEdBQW9CQyxTQUFwQjtBQUNBLFdBQU9iLFFBQVEs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TSxhQUp2QjtBQVFITSx1QkFBYSxvQkFDUnRCLEtBQUssQ0FBQ3NCLGFBREUsc0JBRVZSLE1BQUksQ0FBQzFCLEVBRkssRUFFQTJDLFNBQVEsSUFBSUEsU0FBUSxDQUFDNUMsR0FBVCxDQUFhLFVBQUF5RCxLQUFLO0FBQUEsbUJBQ3ZDLENBQUNBLEtBQUssQ0FBQzdCLE9BQU4sR0FBZ0JuQixPQUFPLENBQUNvQixRQUF6QixLQUFzQzRCLEtBREM7QUFBQSxXQUFsQixDQUFaLElBRUxwRCxTQUpLO0FBUlYsVUFBUDtBQWVEOztBQUVELFNBQUtqQixnREFBTyxDQUFDc0UsV0FBYjtBQUEwQjtBQUN4QixZQUFNZCxVQUFRLEdBQUdELGFBQWEsQ0FBQ2xDLE9BQU8sQ0FBQ1IsRUFBVCxFQUFhWSxLQUFiLENBQTlCOztBQUNBLFlBQU1jLE1BQUksR0FBR1csT0FBTyxDQUFDN0IsT0FBTyxDQUFDUixFQUFULEVBQWFZLEtBQWIsQ0FBcEI7O0FBRUEsZUFBTyxDQUFDYyxNQUFELEdBQ0hkLEtBREcscUJBR0FBLEtBSEE7QUFJSHVCLG1CQUFTLEVBQUVVLGVBQWUsQ0FBQ0ssT0FBTyxDQUFDZixTQUFULG9CQUNyQlQsTUFEcUI7QUFFeEJJLGdCQUFJLEVBQUV0QixPQUFPLENBQUNzQjtBQUZVO0FBSnZCLFVBQVA7QUFTRDtBQXpGSDtBQTRGRCxDQWpHRDs7QUFtR2UseUVBQUE0QixVQUFVO0FBQUEsU0FBSWhELE1BQU0sQ0FBQ0MsVUFBRCxvQkFBa0JxQixZQUFsQixFQUFtQzBCLFVBQW5DLEVBQVY7QUFBQSxDQUF6QixFIiwiZmlsZSI6InJlbmRlci1qcy1zdG9yZS1zdG9yZS5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBhY3Rpb25zID0gW1xuICAnQUREX0RBVEEnLFxuICAnVVBEQVRFX0lURU0nLFxuICAnVVBEQVRFX1NFTEVDVEVEJyxcbiAgJ1VQREFURV9FWFBBTkRFRCcsXG4gICdVUERBVEVfRURJVCdcbl0ucmVkdWNlKChhY3Rpb25zLCBhY3Rpb24pID0+IChcbiAgKGFjdGlvbnNbYWN0aW9uLnRvVXBwZXJDYXNlKCldID0gYWN0aW9uLnRvVXBwZXJDYXNlKCkpICYmIGFjdGlvbnNcbiksIHt9KVxuXG5leHBvcnQgZGVmYXVsdCBhY3Rpb25zIiwiaW1wb3J0IGNsb25lRGVlcCBmcm9tICdsb2Rhc2guY2xvbmVkZWVwJ1xuXG5jb25zdCBXQVRDSEVSUyA9IHt9IFxubGV0IE9OX0RJU1BBVENIXG5sZXQgU1RBVEVcbmNvbnN0IGlzRnVuYyA9IHRlc3QgPT4gdHlwZW9mIHRlc3QgPT09ICdmdW5jdGlvbidcbmNvbnN0IGRlc3Ryb3kgPSAoKSA9PiAoXG4gIE9iamVjdFxuICAgIC5lbnRyaWVzKFdBVENIRVJTKVxuICAgIC5tYXAoKFtpZCwgY2JzXSkgPT4gIHtcbiAgICAgIGNicyAmJiBjYnMubWFwKGNiID0+IGNiICYmIHR5cGVvZiBjYi5kZXN0cm95ID09PSAnZnVuY3Rpb24nICYmIGNiLmRlc3Ryb3koaWQpKVxuICAgICAgV0FUQ0hFUlNbd2F0Y2hlcl0gPSB1bmRlZmluZWRcbiAgICAgIGRlbGV0ZSBXQVRDSEVSU1t3YXRjaGVyXVxuICAgIH0pXG4pXG5jb25zdCBkaXNwYXRjaCA9IChpZCwgLi4ucGF5bG9hZCkgPT4ge1xuICBpZighT05fRElTUEFUQ0gpXG4gICAgcmV0dXJuIGNvbnNvbGUud2FybihgWW91IG11c3QgY3JlYXRlIGEgc3RvcmUgYmVmb3JlIHlvdSBjYW4gZGlzcGF0Y2ggdG8gaXRgKVxuXG4gIHJldHVybiB1cGRhdGUoXG4gICAgT05fRElTUEFUQ0goU1RBVEUsIGlkLCAuLi5wYXlsb2FkKSxcbiAgICBpZFxuICApXG59XG5cbmNvbnN0IGNyZWF0ZSA9IChvbkRpc3BhdGNoLCBzdGF0ZSkgPT4ge1xuICBpZihPTl9ESVNQQVRDSCB8fCBTVEFURSlcbiAgICByZXR1cm4gY29uc29sZS53YXJuKGBkaXNwYXRjaGVyLmNyZWF0ZSBzaG91bGQgb25seSBiZSBjYWxsIG9uY2UgZm9yIGFuIGFwcGxpY2F0aW9uYClcbiAgICBcbiAgaWYoIW9uRGlzcGF0Y2ggfHwgIWlzRnVuYyhvbkRpc3BhdGNoKSlcbiAgICByZXR1cm4gY29uc29sZS53YXJuKGBkaXNwYXRjaGVyLmNyZWF0ZSByZXF1aXJlcyBhbiAnb25EaXNwYXRjaCcgbWV0aG9kYClcbiAgaWYoIXN0YXRlIHx8IHR5cGVvZiBzdG9yZSAhPT0gJ29iamVjdCcpXG4gICAgcmV0dXJuIGNvbnNvbGUud2FybihgY3JlYXRlIHJlcXVpcmVzIGFuIGluaXRpYWwgc3RhdGUgb2YgdHlwZSAnb2JqZWN0J2ApXG5cbiAgT05fRElTUEFUQ0ggPSBvbkRpc3BhdGNoXG4gIFNUQVRFID0gY2xvbmVEZWVwKHN0YXRlKVxuICByZXR1cm4gU1RBVEVcbn1cblxuLyoqXG4gKiBDaGVja3MgdGhlIHN0YXRlIGZvciBhbiB1cGRhdGUsIGFuZCB1cGRhdGVzIHdoZW4gbmVlZGVkXG4gKiBDYWxscyBhbGwgY2JzIGxpbmtlZCB0byB0aGUgcGFzc2VkIGluIGlkXG4gKiBAcGFyYW0gIHthbnl9IHVwZGF0ZWRTdGF0ZSAtIG5ldyBjaGFuZ2VzXG4gKiBAcGFyYW0gIHthbnl9IGlkIC0gdXNlZCB0byBmaW5kIHRoZSBsaW5rZWQgY2FsbGJhY2tzXG4gKiBAcGFyYW0gIHthbnl9IGtleSAtIHVzZWQgdG8gZmluZCB0aGUgbG9jYXRpb24gb2YgdGhlIHN0YXRlIHRoYXQgd2FzIHVwZGF0ZWRcbiAqIEByZXR1cm4geyB2b2lkIH1cbiAqL1xuY29uc3QgdXBkYXRlID0gKHVwZGF0ZWRTdGF0ZSwgaWQpID0+IHtcbiAgLy8gSWYgbm8gdXBkYXRlZCBzdGF0ZSwgb3IgdGhlIGN1cnJlbnQgc3RhdGUgaXMgZXF1YWwgdG8gdGhlIHVwZGF0ZSBzdGF0ZVxuICAvLyBObyB1cGRhdGUsIHNvIGp1c3QgcmV0dXJuXG4gIGlmKCF1cGRhdGVkU3RhdGUgfHwgU1RBVEUgPT09IHVwZGF0ZWRTdGF0ZSlcbiAgICByZXR1cm4gU1RBVEVcblxuICAvLyBPdGhlcndpc2UgdXBkYXRlIHRoZSBzdGF0ZSB3aXRoIHRoZSB1cGRhdGVTdGF0ZSBwYXJhbVxuICBTVEFURSA9IHsgLi4uU1RBVEUsIC4uLnVwZGF0ZWRTdGF0ZSB9XG5cbiAgY29uc3QgY2JzID0gV0FUQ0hFUlNbaWRdXG4gIGNicyAmJlxuICAgIGNicy5sZW5ndGggJiZcbiAgICBjYnMubWFwKGNiID0+IHR5cGVvZiBjYiA9PT0gJ2Z1bmN0aW9uJyAmJiBjYihTVEFURSkpXG4gIFxuICByZXR1cm4gU1RBVEVcbn1cblxuY29uc3Qgd2F0Y2ggPSAoaWQsIGNiKSA9PiB7XG4gIGlmICghY2IgfHwgdHlwZW9mIGNiICE9PSBgZnVuY3Rpb25gKVxuICAgIGNvbnNvbGUud2FybihgWW91IG11c3QgcGFzcyBhIGZ1bmN0aW9uIGFzIHRoZSBzZWNvbmQgYXJndW1lbnQgdG8gc3RvcmUubGlzdGVuKClgKVxuXG4gIFdBVENIRVJTW2lkXSA9IFdBVENIRVJTW2lkXSB8fCBbXVxuICBXQVRDSEVSU1tpZF0ucHVzaChjYilcbn1cblxuY29uc3QgZ2V0V2F0Y2hlcnMgPSAoKSA9PiBXQVRDSEVSU1xuXG5jb25zdCBmb3JnZXQgPSAoaWQsIGNiKSA9PiB7XG4gIGlmKCFpZCB8fCAhV0FUQ0hFUlNbaWRdKVxuICAgIGNvbnNvbGUud2FybihgWW91IG11c3QgcGFzcyBhbmQgaWQgdG8gZm9yZ2V0IGEgd2F0Y2hlcmApXG5cbiAgY29uc3QgY2JJbmRleCA9IFdBVENIRVJTW2lkXS5pbmRleE9mKGNiKVxuICBjYkluZGV4ICE9PSAtMSAmJiBXQVRDSEVSU1tpZF0uc3BsaWNlKGNiSW5kZXgsIDEpO1xufVxuXG5jb25zdCBkaXNwYXRjaGVyID0ge1xuICBjcmVhdGUsXG4gIGRlc3Ryb3ksXG4gIGRpc3BhdGNoLFxuICBmb3JnZXQsXG4gIGdldFdhdGNoZXJzLFxuICB3YXRjaCxcbiAgdXBkYXRlXG59XG5cbmV4cG9ydCBkZWZhdWx0IGRpc3BhdGNoZXIiLCJpbXBvcnQgZGlzcGF0Y2hlciBmcm9tICcuL2Rpc3BhdGNoZXInXG5pbXBvcnQgYWN0aW9ucyBmcm9tICcuL2FjdGlvbnMnXG5jb25zdCB7IGRpc3BhdGNoLCB3YXRjaCwgZm9yZ2V0LCBjcmVhdGUgfSA9IGRpc3BhdGNoZXJcblxuLy8gdGhpcyBpcyB1c2VkIHRvIGRlZmluZSBpZiBhbiBpdGVtIHNob3VsZCBiZSByZS1yZW5kZXJlZFxuLy8gaXQgc2hvdWxkIGNvbnRhaW4gYW55dGhpbmcgdGhhdCBjYW4gYmUgY2hhbmdlZCBieSBhIHVzZXJcbmNvbnN0IHNlcmlhbEl0ZW0gPSBpdGVtID0+IFtcbiAgISFpdGVtLnZpc2libGUsXG4gICEhaXRlbS5leHBhbmRlZCxcbiAgISFpdGVtLnNlbGVjdGVkLFxuICAhIWl0ZW0uZWRpdCxcbl0uam9pbihgYClcblxuY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICBkYXRhOiBbXSxcbiAgc2VsZWN0ZWQ6IG51bGwsXG4gIGNoaWxkcmVuQ2FjaGU6IHt9LFxuICBpdGVtQ2FjaGU6IHt9LFxuICBpc01vZGFsVmlzaWJsZTogZmFsc2UsXG59XG5cbmNvbnN0IGdldEl0ZW0gPSAoaWRPckl0ZW0sIHN0YXRlKSA9PiAoXG4gIHR5cGVvZiBpZE9ySXRlbSA9PT0gYHN0cmluZ2BcbiAgICA/IHN0YXRlLml0ZW1DYWNoZVtpZE9ySXRlbV1cbiAgICA6IGlkT3JJdGVtXG4pXG5jb25zdCBnZXRQYXJlbnQgPSAoaXRlbSwgc3RhdGUpID0+IHtcbiAgaWYgKGl0ZW0ucGFyZW50SXRlbSkgcmV0dXJuIGl0ZW0ucGFyZW50SXRlbVxuICBpZiAoIWl0ZW0ucGFyZW50SWQpIHJldHVybiBudWxsXG5cbiAgaXRlbS5wYXJlbnRJdGVtID0gZ2V0SXRlbShpdGVtLnBhcmVudElkLCBzdGF0ZSlcbiAgcmV0dXJuIGl0ZW0ucGFyZW50SXRlbVxufVxuY29uc3QgZ2V0Q2hpbGRyZW5PZiA9IChpZCwgc3RhdGUpID0+IHtcbiAgaWYgKGlkIGluIHN0YXRlLmNoaWxkcmVuQ2FjaGUpXG4gICAgcmV0dXJuIHN0YXRlLmNoaWxkcmVuQ2FjaGVbaWRdXG5cbiAgY2hpbGRyZW4gPSBzdGF0ZS5kYXRhLmZpbHRlcihpdGVtID0+IGl0ZW0ucGFyZW50SWQgPT09IGlkKVxuXG4gIHJldHVybiBjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGhcbiAgICA/IGNoaWxkcmVuXG4gICAgOiBmYWxzZVxufVxuXG5jb25zdCB1cGRhdGVJdGVtQ2FjaGUgPSAoaXRlbUNhY2hlLCBpdGVtKSA9PiAoe1xuICAuLi5pdGVtQ2FjaGUsXG4gIFtpdGVtLmlkXToge1xuICAgIC4uLml0ZW1DYWNoZVtpdGVtLmlkXSxcbiAgICAuLi5pdGVtXG4gIH1cbn0pXG5cbmNvbnN0IG9uRGlzcGF0Y2ggPSAoc3RhdGUsIC4uLmFjdGlvbikgPT4ge1xuICBjb25zdCB7IHR5cGUsIC4uLnBheWxvYWQgfSA9IGFjdGlvblxuICBpZighdHlwZSB8fCAhT2JqZWN0LmtleXMocGF5bG9hZCkubGVuZ3RoKVxuICAgIHJldHVybiBzdGF0ZVxuICBcbiAgc3dpdGNoKHR5cGUpe1xuXG4gICAgY2FzZSBhY3Rpb25zLkFERF9EQVRBOiB7XG4gICAgICAvLyBuZXdEYXRhID09PSBBcnJheVxuICAgICAgcmV0dXJuICFwYXlsb2FkLm5ld0RhdGFcbiAgICAgICAgPyBzdGF0ZVxuICAgICAgICA6IHtcbiAgICAgICAgICAgIC4uLnN0YXRlLFxuICAgICAgICAgICAgZGF0YTogdXBkYXRlZC5kYXRhLmNvbmNhdChwYXlsb2FkLm5ld0RhdGEpLFxuICAgICAgICAgICAgaXRlbUNhY2hlOiBwYXlsb2FkLm5ld0RhdGEucmVkdWNlKChpdGVtQ2FjaGUsIGl0ZW0pID0+IChcbiAgICAgICAgICAgICAgKGl0ZW1DYWNoZVtpdGVtLmlkXSA9IGl0ZW0pICYmIGl0ZW1DYWNoZSksXG4gICAgICAgICAgICAgIHVwZGF0ZWQuaXRlbUNhY2hlXG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBjYXNlIGFjdGlvbnMuVVBEQVRFX0lURU06IHtcbiAgICAgIGlmKCFwYXlsb2FkIHx8ICFwYXlsb2FkLmlkKVxuICAgICAgICByZXR1cm4gc3RhdGVcblxuICAgICAgY29uc3QgaXRlbSA9IGdldEl0ZW0ocGF5bG9hZC5pZCwgc3RhdGUpXG4gICAgICAvLyBJZiBubyB1cGRhdGUsIG9yIHRoZSBpdGVtIGhhcyBub3QgYmVlbiB1cGRhdGUsIGp1c3QgcmV0dXJuXG4gICAgICByZXR1cm4gIWl0ZW0gfHwgc2VyaWFsSXRlbShpdGVtKSA9PT0gc2VyaWFsSXRlbShwYXlsb2FkKVxuICAgICAgICA/IHN0YXRlXG4gICAgICAgIDoge1xuICAgICAgICAgIC4uLnN0YXRlLFxuICAgICAgICAgIGl0ZW1DYWNoZTogdXBkYXRlSXRlbUNhY2hlKHN0YXRlLml0ZW1DYWNoZSwgcGF5bG9hZClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNhc2UgYWN0aW9ucy5VUERBVEVfU0VMRUNURUQ6IHtcbiAgICAgIGNvbnN0IHVwZGF0ZWQgPSB7IC4uLnN0YXRlLCBzZWxlY3RlZDogbnVsbCB9XG4gICAgICAvLyBSZW1vdmUgY3VycmVudCBzZWxlY3RlZFxuICAgICAgaWYoc3RhdGUuc2VsZWN0ZWQpe1xuICAgICAgICBjb25zdCBjdXJJZCA9IHN0YXRlLnNlbGVjdGVkLmlkXG4gICAgICAgIHVwZGF0ZWQuaXRlbUNhY2hlID0gdXBkYXRlSXRlbUNhY2hlKHVwZGF0ZWQuaXRlbUNhY2hlLCB7XG4gICAgICAgICAgLi4udXBkYXRlZC5pdGVtQ2FjaGVbY3VySWRdLFxuICAgICAgICAgIHNlbGVjdGVkOiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIC8vIEdldCB0aGUgaXRlbSB0byB1cGRhdGVcbiAgICAgIGNvbnN0IGl0ZW0gPSBnZXRJdGVtKHBheWxvYWQuaWQsIHN0YXRlKVxuICAgICAgLy8gaWYgbm8gaXRlbSB0byB1cGRhdGUgcmV1dHJuXG4gICAgICBpZighaXRlbSkgcmV0dXJuIHVwZGF0ZWRcbiAgICAgIC8vIFVwZGF0ZSB0aGUgcGFzc2VkIGluIGl0ZW0gdG8gc2VsZWN0ZWRcbiAgICAgIHVwZGF0ZWQuaXRlbUNhY2hlID0gdXBkYXRlSXRlbUNhY2hlKHVwZGF0ZWQuaXRlbUNhY2hlLCB7XG4gICAgICAgIC4uLml0ZW0sXG4gICAgICAgIHNlbGVjdGVkOiB0cnVlLFxuICAgICAgfSlcbiAgICAgIHVwZGF0ZWQuc2VsZWN0ZWQgPSBpdGVtXG5cbiAgICAgIC8vIHJldHVybiB1cGRhdGVkIHN0YXRlXG4gICAgICByZXR1cm4gdXBkYXRlZFxuICAgIH1cbiAgICBcbiAgICBjYXNlIGFjdGlvbnMuVVBEQVRFX0VYUEFOREVEOiB7XG4gICAgICBjb25zdCBjaGlsZHJlbiA9IGdldENoaWxkcmVuT2YocGF5bG9hZC5pZCwgc3RhdGUpXG4gICAgICBjb25zdCBpdGVtID0gZ2V0SXRlbShwYXlsb2FkLmlkLCBzdGF0ZSlcbiAgICAgIFxuICAgICAgcmV0dXJuICFpdGVtXG4gICAgICAgID8gc3RhdGVcbiAgICAgICAgOiB7XG4gICAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgICAgaXRlbUNhY2hlOiB1cGRhdGVJdGVtQ2FjaGUodXBkYXRlZC5pdGVtQ2FjaGUsIHtcbiAgICAgICAgICAgIC4uLml0ZW0sXG4gICAgICAgICAgICBleHBhbmRlZDogcGF5bG9hZC5leHBhbmRlZCxcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBjaGlsZHJlbkNhY2hlOiB7XG4gICAgICAgICAgICAuLi5zdGF0ZS5jaGlsZHJlbkNhY2hlLFxuICAgICAgICAgICAgW2l0ZW0uaWRdOiBjaGlsZHJlbiAmJiBjaGlsZHJlbi5tYXAoY2hpbGQgPT4gKFxuICAgICAgICAgICAgICAoY2hpbGQudmlzaWJsZSA9IHBheWxvYWQuZXhwYW5kZWQpICYmIGNoaWxkXG4gICAgICAgICAgICApKSB8fCB1bmRlZmluZWRcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjYXNlIGFjdGlvbnMuVVBEQVRFX0VESVQ6IHtcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gZ2V0Q2hpbGRyZW5PZihwYXlsb2FkLmlkLCBzdGF0ZSlcbiAgICAgIGNvbnN0IGl0ZW0gPSBnZXRJdGVtKHBheWxvYWQuaWQsIHN0YXRlKVxuICAgICAgXG4gICAgICByZXR1cm4gIWl0ZW1cbiAgICAgICAgPyBzdGF0ZVxuICAgICAgICA6IHtcbiAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICBpdGVtQ2FjaGU6IHVwZGF0ZUl0ZW1DYWNoZSh1cGRhdGVkLml0ZW1DYWNoZSwge1xuICAgICAgICAgICAgLi4uaXRlbSxcbiAgICAgICAgICAgIGVkaXQ6IHBheWxvYWQuZWRpdCxcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgfVxuXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgc3RhcnRTdGF0ZSA9PiBjcmVhdGUob25EaXNwYXRjaCwgeyAuLi5pbml0aWFsU3RhdGUsIC4uLnN0YXJ0U3RhdGUgfSlcblxuXG4iXSwic291cmNlUm9vdCI6IiJ9